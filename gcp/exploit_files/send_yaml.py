#!/usr/bin/python3

from sys import argv
import requests
import json


def main(argv):
	if len(argv) != 3:
		print("[+] Usage: {} <lambda-addr> <yaml-file-to-send>".format(argv[0]))
		return

	lambda_addr = argv[1]
	filepath 	= argv[2]

	try:
		with open(filepath, "r") as yaml_file:
			content = yaml_file.read()
	except FileNotFoundError:
		print("[+] File {} doesn't exist".format(filepath))
		return

	send_data_print_resp(lambda_addr, content)


def send_data_print_resp(lambda_addr, data):
	post_data = {"yamlData": data}
	response = requests.post(lambda_addr, json=post_data)

	decoded = response.content.decode('utf8')
	try:
		data = json.loads(decoded)
		if "body" in data:
			data = data["body"]
			if type(data) != dict:
				data = json.loads(data)
	except json.decoder.JSONDecodeError as e:
		print(decoded)
		print("[!] send_command: Lambda response body isn't JSON decodeable. \nError: {}\nReceived data: {}".format(str(e), decoded))

	print(data)


if __name__ == "__main__":
	main(argv)